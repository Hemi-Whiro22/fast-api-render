core:
  orchestrator_realm: Te-Po (backend) + Te-Ao (frontend) + mauri (realm configs)
  fastapi_entrypoint:
    file: Te-Po/core/main.py
    description: FastAPI application bootstrap mounting OCR, Translate, Embed, Memory, Mauri, and Intake routers.
    validation_pipeline:
      module: Te-Po/utils/env_validator.py
      actions:
        - Load optional .env with python-dotenv when available.
        - Validate required environment variables and mask secrets in logs.
        - Check LANG and LC_ALL for mi_NZ.UTF-8 locale alignment.
        - Persist structured report to logs/system_health.json.
      artifacts:
        - logs/system_health.json
        - console summary during startup
  settings_module:
    file: Te-Po/core/config.py
    description: Pydantic BaseSettings wired to the secure env loader; Te-Po/config.py re-exports for legacy imports.
    loader:
      file: Te-Po/core/env_loader.py
      guarantees:
        - load_dotenv executes before settings instantiation and respects Render overrides.
        - Secrets masked (first six characters only) in console summaries.
        - LANG and LC_ALL default to mi_NZ.UTF-8 when unset.
        - Logs source precedence (e.g., .env.local+.env, system, render) to env_validation.log.
    environment_variables:
      SUPABASE_URL:
        required: true
        consumers:
          - Te-Po/utils/supabase_client.py
          - Te-Po/routes/tiwhanawhana/intake_bridge.py
          - backend/utils/env_validator.py
          - logs/env_validation.log (audit trail via env_loader)
      SUPABASE_SERVICE_ROLE_KEY:
        required: true
        consumers:
          - backend/utils/supabase_client.py
          - backend/routes/tiwhanawhana/intake_bridge.py
      SUPABASE_ANON_KEY:
        required: false
        consumers:
          - backend/utils/supabase_client.py (fallback when service key missing)
      SUPABASE_PUBLISHABLE_KEY:
        required: false
        consumers:
          - reserved for frontend or public SDK usage (not referenced yet)
      OPENAI_API_KEY:
        required: true
        consumers:
          - backend/utils/openai_client.py
          - logs/env_validation.log (masked).
      LANG:
        required: false
        consumers:
          - backend/utils/env_validator.py (locale check)
          - backend/core/env_loader.py (defaults to mi_NZ.UTF-8)
      LC_ALL:
        required: false
        consumers:
          - backend/utils/env_validator.py (locale check)
          - backend/core/env_loader.py (defaults to mi_NZ.UTF-8)
    notes:
      - Optional toggles (offline_mode, database_url, memory_table) now ship with safe defaults to match consumer expectations.
      - Supabase table alias defaults (ocr_logs, translations, embeddings, ti_memory) mirror existing route behaviour.
      - Translation and embedding model defaults can be overridden via environment variables if different models are required.
      - env_loader writes masked summaries to logs/env_validation.log for compliance auditing.
  render_startup:
    entrypoint: backend/core/main.py
    start_script: start.sh
    environment_health_endpoint: /env/health
    behaviour:
      - Calls load_env() then get_settings() before FastAPI instantiation to satisfy secret validation.
      - Logs masked environment preview and UTF-8 verification status on import and startup.
      - Reports configuration source precedence for auditing.
      - Applies UTF-8 middleware globally and reuses core routers (OCR, Translate, Embed, Memory, Mauri, Intake).
      - Writes UTF-8 verification outcome to logs/env_validation.log (includes "UTF-8 verified: True").
    render_config:
      start_command: ./start.sh
      build_command: pip install -r requirements.txt && chmod +x start.sh
      env_expectations:
        - LANG and LC_ALL provided by Render env vars still default to mi_NZ.UTF-8 via start.sh fallback.
        - Secrets supplied via Render dashboard override local .env values.
  data_models:
    file: backend/models/tiwhanawhana_models.py
    description: SQLAlchemy models for mauri_logs, task_queue, ocr_logs, translations, embeddings, and ti_memory within schema tiwhanawhana.

shared_clients:
  openai_client:
    file: backend/utils/openai_client.py
    provides:
      - translate_text
      - generate_embedding
    dependencies:
      - OPENAI_API_KEY
      - settings.translation_model (referenced)
      - settings.embedding_model (referenced)
    fallback_behavior: offline_mode generates deterministic hashes when settings.offline_mode is truthy.
    notes:
      - Requires Settings.offline_mode, translation_model, and embedding_model attributes.
  supabase_client:
    file: backend/utils/supabase_client.py
    provides:
      - insert_record
      - fetch_records
      - update_record
      - delete_record
      - fetch_latest
    behavior:
      - On missing credentials or placeholder keys, logs development-mode intent and returns inert responses.
      - Creates client once at module import when credentials are present.
    environment:
      - SUPABASE_URL
      - SUPABASE_SERVICE_ROLE_KEY or SUPABASE_ANON_KEY
  pgvector_client:
    file: backend/utils/pgvector_client.py
    provides:
      - store_embedding
      - search_embeddings
    dependencies:
      - settings.database_url (not currently defined in Settings)
      - pgvector Python package and PostgreSQL extension
    fallback_behavior: delegates to backend/utils/offline_store.py when settings.offline_mode is truthy.
  offline_store:
    file: backend/utils/offline_store.py
    purpose: SQLite fallback for embeddings, OCR logs, translations, task queue, and mauri logs when offline_mode enabled.
    data_path: data/tiwhanawhana.db

routes:
  general:
    - name: ocr
      prefix: /ocr
      router_file: backend/routes/ocr.py
      response_model: OCRResponse
      service_dependencies:
        - backend/utils/openai_client.generate_embedding
        - backend/utils/pgvector_client.store_embedding
      persistence:
        - Supabase table (settings.supabase_table_ocr_logs default ocr_logs)
        - Optional vector store via memory_table
      frontend_panel: frontend/src/panels/OCRPanel.jsx
      documentation: ARCHITECTURE_DIAGRAM.md (OCR flow)
    - name: translate
      prefix: /translate
      router_file: backend/routes/translate.py
      response_model: TranslationResponse
      service_dependencies:
        - backend/utils/openai_client.translate_text
      persistence:
        - Supabase table (settings.supabase_table_translations default translations)
      frontend_panel: frontend/src/panels/TranslatePanel.jsx
    - name: embed
      prefix: /embed
      router_file: backend/routes/embed.py
      response_model: EmbeddingResponse
      service_dependencies:
        - backend/utils/openai_client.generate_embedding
        - backend/utils.pgvector_client.get_pgvector_client
      persistence:
        - Supabase table (settings.supabase_table_embeddings default embeddings)
        - pgvector store via insert_embedding
      frontend_panel: none (API utility for downstream agents)
    - name: memory
      prefix: /memory
      router_file: backend/routes/memory.py
      endpoints:
        - GET /
        - POST /retrieve
      service_dependencies:
        - backend/utils/openai_client.generate_embedding
        - backend/utils.pgvector_client.search_embeddings
        - backend/utils.supabase_client.fetch_records
      frontend_panel: frontend/src/panels/MemoryPanel.jsx
  tiwhanawhana_namespace:
    - name: tiwhanawhana_ocr
      prefix: /tiwhanawhana/ocr
      router_file: backend/routes/tiwhanawhana/ocr.py
      service_dependencies:
        - backend/services/tiwhanawhana.perform_ocr
      persistence:
        - Supabase table tiwhanawhana.ocr_logs via utils.supabase_client.insert_record
    - name: tiwhanawhana_translate
      prefix: /tiwhanawhana/translate (pending)
      router_file: backend/routes/tiwhanawhana/translate.py (not present)
      notes: Only generic translate route exists; confirm whether dedicated namespace is required.
    - name: tiwhanawhana_embed
      prefix: /tiwhanawhana/embed
      router_file: backend/routes/tiwhanawhana/embed.py
      service_dependencies:
        - backend/services/tiwhanawhana.create_embedding
      persistence:
        - Supabase table tiwhanawhana.embeddings
    - name: tiwhanawhana_memory
      prefix: /tiwhanawhana/memory
      router_file: backend/routes/tiwhanawhana/memory.py
      service_dependencies:
        - backend/services/tiwhanawhana.search_memory
        - backend/utils.supabase_client.insert_record
    - name: tiwhanawhana_mauri
      prefix: /tiwhanawhana/mauri
      router_file: backend/routes/tiwhanawhana/mauri.py
      service_dependencies:
        - backend/services/tiwhanawhana.log_mauri
        - backend/utils.supabase_client.fetch_latest
        - backend/utils.supabase_client.insert_record
    - name: tiwhanawhana_intake
      prefix: /intake
      router_file: backend/routes/tiwhanawhana/intake.py
      background_tasks:
        - scan_intake schedules async processing of discovered documents via TiwhanawhanaIntakeBridge.process_document.
        - start_continuous_scan triggers run_intake_loop interval worker.
      service_dependencies:
        - backend/routes/tiwhanawhana/intake_bridge.py
      notes:
        - BackgroundTasks.add_task receives async functions; wrap with asyncio.create_task to ensure execution.

services:
  tiwhanawhana_service:
    file: backend/services/tiwhanawhana.py
    capabilities:
      - perform_ocr
      - create_embedding
      - search_memory
      - log_mauri
    shared_utilities:
      - cosine_similarity via offline_store
  core_microservice_stub:
    file: backend/services/core/main.py
    purpose: placeholder FastAPI app exposing /status and /test for orchestrator experiments.
  ocr_microservice_stub:
    file: backend/services/ocr/main.py
    purpose: standalone OCR FastAPI example pending Supabase integration.
  render_microservices:
    status: scaffolded
    utf8_middleware: backend/utils/middleware/utf8_enforcer.py
    schema_helper: backend/utils/supabase_schema.py
    render_yaml: render.yaml
    services:
      - name: core_service
        entrypoint: backend/services/core/main.py
        status: ready
        health_endpoints:
          - /health
          - /status
      - name: ocr_service
        entrypoint: backend/services/ocr/main.py
        status: ready
        health_endpoints:
          - /health
          - /status
      - name: translate_service
        entrypoint: backend/services/translate/main.py
        status: ready
        health_endpoints:
          - /health
          - /status
      - name: embed_service
        entrypoint: backend/services/embed/main.py
        status: ready
        health_endpoints:
          - /health
          - /status
      - name: memory_service
        entrypoint: backend/services/memory/main.py
        status: ready
        health_endpoints:
          - /health
          - /status
      - name: mauri_service
        entrypoint: backend/services/mauri/main.py
        status: ready
        health_endpoints:
          - /health
          - /status
      - name: intake_service
        entrypoint: backend/services/intake/main.py
        status: ready
        health_endpoints:
          - /health
          - /status
      - name: carving_service
        entrypoint: backend/services/carver/main.py
        status: ready
        health_endpoints:
          - /health
          - /status

intake:
  bridge:
    class: TiwhanawhanaIntakeBridge
    file: backend/routes/tiwhanawhana/intake_bridge.py
    responsibilities:
      - scan_intake_folder for .md, .json, .txt assets under kaitiaki-intake/active
      - read_document interprets file formats and returns structured payloads
      - process_document generates ids, stores artifacts in Supabase, and enqueues Whiro audits
      - run_intake_loop maintains continuous ingestion with configurable interval
      - log_heartbeat writes glyph metadata to Supabase
    supabase_tables:
      - rongohia.artifacts
      - task_queue
      - rongohia.carvings
      - rongohia.meta
    notes:
      - create_client invoked at import; guard against missing credentials to prevent import failure.
  api_routes:
    file: backend/routes/tiwhanawhana/intake.py
    endpoints:
      - GET /intake/status
      - POST /intake/scan
      - POST /intake/process/{document_name}
      - GET /intake/documents
      - POST /intake/start-continuous-scan
    background_task_notes:
      - BackgroundTasks expects sync callables; convert async def helpers to wrappers or spawn tasks manually.
      - process_document and scan_intake rely on TiwhanawhanaIntakeBridge global singleton.
  watchdog_assets:
    directories:
      - backend/kaitiaki-intake/active (ingestion source)
      - backend/kaitiaki-intake/processed (destination placeholder)
      - backend/logs/system_health.json (health artifact)

frontend:
  framework: Vite + React (React 18, Tailwind classes in JSX components).
  api_hook:
    file: frontend/src/hooks/useApi.js
    description: memoized fetch wrapper with base URL http://localhost:8000.
  panels:
    - file: frontend/src/panels/OCRPanel.jsx
      binds_to: POST /ocr
      notes: Displays response.filename, response.text, and confidence.
    - file: frontend/src/panels/TranslatePanel.jsx
      binds_to: POST /translate
      notes: Sends text and target_language payload; expect translation field in response.
    - file: frontend/src/panels/MemoryPanel.jsx
      binds_to:
        - GET /memory
        - POST /memory/retrieve
      notes: Supports min_similarity slider and displays search results.
  main_app:
    file: frontend/src/App.jsx
    description: Layout composing OCR, Translate, and Memory panels with header branding.

risks:
  - Tests in backend/tests/test_all_endpoints.py target legacy endpoints (/ocr/image, /memory/logs) and will fail against current routes, leading to false negatives.
  - utils/mana_trace.py references an undefined susupabase object and loads high-privilege keys from .mauri/.env; execution will fail and may risk credential leakage if corrected without care.
  - Shared clients assume SUPABASE_SERVICE_ROLE_KEY availability; ensure public-facing contexts never expose service-role credentials.

manifest_audit:
  - Dedicated /tiwhanawhana/translate router is referenced in documentation but not present in code.
  - Verify whether offline_mode is intentional; document default behavior before enabling fallbacks.
  - Monitor new Settings defaults in production to confirm they align with deployed environments.
  - Background task scheduler wrappers landed; observe runtime logs to ensure create_task scheduling behaves as expected.
  - Supabase intake bridge now dry-runs without credentials; confirm behaviour matches operator expectations.

maintenance_notes:
  - Re-run repository scan after each carve or deployment change and refresh this manifest accordingly.
  - When new routers or services are introduced, append entries with file paths, prefixes, and dependencies.
  - Capture any divergence between documentation and implementation under manifest_audit until resolved.
